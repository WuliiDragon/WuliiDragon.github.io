<!DOCTYPE html>
<html lang="zh-Hans">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="æœ€è¿‘ç½‘ä¸Šçœ‹äº†ä¸å°‘runtimeçš„æ–‡ç« ï¼Œè‡ªå·±æ€»ç»“ä¸€äº›ä¹Ÿæ‘˜æŠ„ä¸€äº›ï¼Œé¿å…è¿‡å¿«çš„å¿˜è®°
runtimeå¼•å…¥
å½“æˆ‘ä»¬åœ¨ç¼–å†™OCä»£ç æ—¶ï¼Œæˆ–è€…æ˜¯åœ¨çœ‹åšå®¢çš„æ—¶å€™ï¼Œæˆ–è€…åœ¨æœ€åˆå­¦ä¹ OCè¯­æ³•çš„æ—¶å€™ï¼Œå½“å»è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ä¸æ­¢ä¸€æ¬¡çš„çœ‹åˆ°æˆ–è€…è¢«å‘ŠçŸ¥è¿™ç§è¡Œä¸ºä¸æ˜¯è°ƒç”¨æ–¹å¼è€Œæ˜¯åœ¨â€œå‘æ¶ˆæ¯â€ è¿™ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯å¾ˆå°‘æˆ–è€…æ²¡æœ‰å»äº†è§£ç©¶ç«Ÿæ˜¯ä¸ºä»€ä¹ˆã€‚">
    

    <!--Author-->
    
        <meta name="author" content="Dragon">
    

    <!-- Title -->
    
    <title>å°ç™½çœ‹runtimeï¼ˆä¸€ï¼‰åŸºæœ¬æ¦‚å¿µ | Dragonçš„åšå®¢</title>

    <!-- Bootstrap Core CSS -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Noto+Serif:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <!-- Content -->
    <section class="article-container">
<!-- Back Home -->
<a class="nav-back" href="/">
    <i class="fa fa-home fa-3x"></i>
</a>

<!-- Page Header -->
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>å°ç™½çœ‹runtimeï¼ˆä¸€ï¼‰åŸºæœ¬æ¦‚å¿µ</h1>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="post-content col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>æœ€è¿‘ç½‘ä¸Šçœ‹äº†ä¸å°‘runtimeçš„æ–‡ç« ï¼Œè‡ªå·±æ€»ç»“ä¸€äº›ä¹Ÿæ‘˜æŠ„ä¸€äº›ï¼Œé¿å…è¿‡å¿«çš„å¿˜è®°</p>
<h3 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h3><p>å¼•å…¥</p>
<p>å½“æˆ‘ä»¬åœ¨ç¼–å†™OCä»£ç æ—¶ï¼Œæˆ–è€…æ˜¯åœ¨çœ‹åšå®¢çš„æ—¶å€™ï¼Œæˆ–è€…åœ¨æœ€åˆå­¦ä¹ OCè¯­æ³•çš„æ—¶å€™ï¼Œå½“å»è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ä¸æ­¢ä¸€æ¬¡çš„çœ‹åˆ°æˆ–è€…è¢«å‘ŠçŸ¥è¿™ç§è¡Œä¸ºä¸æ˜¯è°ƒç”¨æ–¹å¼è€Œæ˜¯åœ¨â€œå‘æ¶ˆæ¯â€ è¿™ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯å¾ˆå°‘æˆ–è€…æ²¡æœ‰å»äº†è§£ç©¶ç«Ÿæ˜¯ä¸ºä»€ä¹ˆã€‚é‚£ç©¶ç«Ÿä¸ºä»€ä¹ˆæŠŠâ€œæ–¹æ³•è°ƒç”¨â€ç§°ä½œå‘æ¶ˆæ¯å‘¢ï¼Ÿ</p>
<p>è¿™å°±è¦ä»OCè¯­è¨€è®²èµ·ï¼Œä¼—æ‰€å‘¨çŸ¥ OCæ˜¯ä¸€é—¨åŠ¨æ€è¯­è¨€ï¼Œä»€ä¹ˆæ˜¯åŠ¨æ€è¯­è¨€å‘¢ï¼Ÿ</p>
<blockquote>
<p>åŠ¨æ€è¯­è¨€ï¼Œæ˜¯æŒ‡ç¨‹åºåœ¨è¿è¡Œæ—¶å¯ä»¥æ”¹å˜å…¶ç»“æ„ï¼šæ–°çš„å‡½æ•°å¯ä»¥è¢«å¼•è¿›ï¼Œå·²æœ‰çš„å‡½æ•°å¯ä»¥è¢«åˆ é™¤ç­‰åœ¨ç»“æ„ä¸Šçš„å˜åŒ–ã€‚æ¯”å¦‚ä¼—æ‰€å‘¨çŸ¥çš„JavaScriptä¾¿æ˜¯ä¸€ä¸ªåŠ¨æ€è¯­è¨€ã€‚é™¤æ­¤ä¹‹å¤–å¦‚Rubyã€Pythonç­‰ä¹Ÿéƒ½å±äºåŠ¨æ€è¯­è¨€ï¼Œè€ŒCã€C++ç­‰è¯­è¨€åˆ™ä¸å±äºåŠ¨æ€è¯­è¨€ã€‚</p>
</blockquote>
<p>æ—¢ç„¶æœ‰åŠ¨æ€è¯­è¨€é‚£è‚¯å®šæœ‰é™æ€è¯­è¨€ï¼š</p>
<blockquote>
<p>é™æ€ç±»å‹è¯­è¨€çš„ç±»å‹åˆ¤æ–­æ˜¯åœ¨è¿è¡Œå‰åˆ¤æ–­ï¼ˆå¦‚ç¼–è¯‘é˜¶æ®µï¼‰ï¼Œæ¯”å¦‚C#ã€javaå°±æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œé™æ€ç±»å‹è¯­è¨€ä¸ºäº†è¾¾åˆ°å¤šæ€ä¼šé‡‡å–ä¸€äº›ç±»å‹é‰´åˆ«æ‰‹æ®µï¼Œå¦‚ç»§æ‰¿ã€æ¥å£ï¼Œç­‰ç‰¹æ®Šè¯­æ³•ã€‚</p>
</blockquote>
<p>æ‰€ä»¥ä¸åŒäºé™æ€ç±»å‹è¯­è¨€ OCæ€»æ˜¯æƒ³åŠæ³•æŠŠä¸€äº›å†³å®šå·¥ä½œä»ç¼–è¯‘è¿æ¥æ¨è¿Ÿåˆ°è¿è¡Œæ—¶ï¼Œéœ€è¦ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶ç³»ç»Ÿ (runtime system) ä¸€èµ·æ¥æ‰§è¡Œç¼–è¯‘åçš„ä»£ç ã€‚</p>
<p>Cè¯­è¨€æ˜¯ä¸€é—¨é™æ€è¯­è¨€ï¼ŒCè¯­è¨€æ˜¯OCçš„åŸºçŸ³ï¼Œ<code>è¿è¡Œæ—¶æœºåˆ¶(runtime system)</code>ä¸ä»…ä½¿å¾—OCä¿æŒçš„Cè¯­è¨€ç¼–è¯‘æ—¶çš„ç‰¹æ€§(å¦‚ç±»å‹æ£€æŸ¥) è¿˜å€Ÿé‰´äº†smalltalkæœºåˆ¶ä¸ºå…¶æ·»åŠ äº†è¿è¡Œæ—¶æœºåˆ¶ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦ä»‹ç»çš„runtimeæœºåˆ¶ï¼Œruntimeæœºåˆ¶ä½¿å¾—Cè¯­è¨€å…·æœ‰äº†é¢å¯¹å¯¹è±¡çš„ç‰¹æ€§ï¼Œæ‰€ä»¥å°±æœ‰äº†OCã€‚</p>
<p>runtimeæ˜¯ç”±Cå’Œæ±‡ç¼–ç¼–å†™çš„ï¼Œç›®å‰æœ‰ä¸¤ä¸ªç‰ˆæœ¬ modern å’Œ legacy ç°åœ¨ä½¿ç”¨çš„Object-C 2.0æ˜¯modernç‰ˆæœ¬çš„runtimeç³»ç»Ÿï¼Œåªèƒ½è¿è¡Œåœ¨iOSå’ŒOS X10.5ä¹‹åçš„64ä½ç¨‹åºã€‚è€ŒOS Xè¾ƒè€çš„32ä½ç¨‹åºä»ç„¶é‡‡ç”¨Object-c 1 ä¸­legacyç‰ˆæœ¬çš„runtimeç³»ç»Ÿã€‚</p>
<p>æ€»ç»“æ¥è¯´ OCæ˜¯åŠ¨æ€ç±»å‹è¯­è¨€è®¸å¤šäº‹æƒ…åœ¨ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šï¼Œéœ€è¦ç­‰åœ¨è¿è¡Œæ—¶ã€‚è€Œé€ æˆè¿™ç§ç°è±¡çš„å› ä¸ºruntimeæœºåˆ¶çš„å­˜åœ¨ã€‚</p>
<p>å­¦ä¹ runtimeå…ˆä»è€ç”Ÿå¸¸è°ˆçš„objc_msgSendå‡½æ•°è°ˆèµ·</p>
<h3 id="objc-msgSendå‡½æ•°"><a href="#objc-msgSendå‡½æ•°" class="headerlink" title="objc_msgSendå‡½æ•°"></a>objc_msgSendå‡½æ•°</h3><p>æ–°å»ºä¸€ä¸ªPersonç±»æœ‰å®ä¾‹æ–¹æ³•å’Œç±»æ–¹æ³•</p>
<ul>
<li><code>-(void)instanceMethod;</code></li>
<li><code>+(void)classMethod;</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@interface Person : NSObject</div><div class="line">-(void)instanceMethod;</div><div class="line">+(void)classMethod;</div><div class="line">@end</div><div class="line">-(void)instanceMethod&#123;</div><div class="line">    NSLog(@&quot;instanceMethod is print&quot;);</div><div class="line"></div><div class="line">&#125;</div><div class="line">+(void)classMethod&#123;</div><div class="line">    NSLog(@&quot;classMethod is print&quot;);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        Person *per = [[Person alloc] init];</div><div class="line">        //å¾ˆç®€å•å‘é€&apos;è°ƒç”¨&apos;ä¸¤ä¸ªæ–¹æ³• åˆ†åˆ«æ˜¯ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•</div><div class="line">        [Person classMethod];</div><div class="line">        [per instanceMethod];</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line">è¾“å‡ºï¼š</div><div class="line">2017-04-29 11:13:21.493311+0800 runtime[5163:1579843] classMethod is print</div><div class="line">2017-04-29 11:13:21.493433+0800 runtime[5163:1579843] instanceMethod is print</div></pre></td></tr></table></figure>
<p>åœ¨main.mç›®å½•ä¸‹ ä½¿ç”¨<code>clang -rewrite-objc main.m</code>ç¼–è¯‘mian.mæ–‡ä»¶ç”Ÿæˆmain.cpp<br>æ‘˜æŠ„ä¸€äº›é‡è¦çš„ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool;</div><div class="line">        Person *per = ((Person *(*)(id, SEL))(void *)objc_msgSend)((id)((Person *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;Person&quot;), sel_registerName(&quot;alloc&quot;)), sel_registerName(&quot;init&quot;));</div><div class="line"></div><div class="line">        ((void (*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;Person&quot;), sel_registerName(&quot;classMethod&quot;));</div><div class="line">        ((void (*)(id, SEL))(void *)objc_msgSend)((id)per, sel_registerName(&quot;instanceMethod&quot;));</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€å…±å‡ºç°å››æ¬¡<code>objc_msgSend</code>å‡½æ•°alloc å’Œinitæ—¶å€™ä»¥åŠâ€™è°ƒç”¨â€™æˆ‘ä»¬è‡ªå·±è®¾ç½®çš„æ–¹æ³•</p>
<p>é™¤å»å¤–è¡£æˆ‘ä»¬åªçœ‹å‡½æ•°çš„å‚æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">objc_msgSend(objc_getClass(&quot;Person&quot;), sel_registerName(&quot;classMethod&quot;));  </div><div class="line"></div><div class="line">objc_msgSend(per, sel_registerName(&quot;instanceMethod&quot;));</div></pre></td></tr></table></figure>
<p>åœ¨æºç é‡Œé¢æŸ¥çœ‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">id objc_msgSend(id self, SEL op, ...)</div></pre></td></tr></table></figure></p>
<p>å‡½æ•°å£°æ˜é•¿è¿™æ ·å­<br>ç¬¬ä¸€ä¸ªå‚æ•°ç±»å‹ä¸ºidï¼Œå¤§å®¶å¯¹å®ƒéƒ½ä¸é™Œç”Ÿï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘ç±»å®ä¾‹çš„æŒ‡é’ˆ<br>é•¿è¿™æ ·ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_object *id;</div></pre></td></tr></table></figure></p>
<p>å­¦è¿‡Cè¯­è¨€å¾ˆå¿«å°±èƒ½çœ‹å‡ºidæ˜¯ä¸€ä¸ªæŒ‡å‘objc_objectç»“æ„ä½“çš„æŒ‡é’ˆã€‚<br>é‚£æˆ‘ä»¬å°±æŸ¥çœ‹ä¸‹ç»“æ„ä½“é‡Œæœ‰äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">struct objc_object &#123;</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>åªæœ‰ä¸€ä¸ªClassç±»å‹çš„æŒ‡é’ˆ</p>
<p>é‚£Classåˆæ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_class *Class;</div></pre></td></tr></table></figure>
<p>åŸæ¥æ˜¯ä¸ªæŒ‡å‘objc_classç»“æ„ä½“çš„æŒ‡é’ˆå•Š<br>æ—¢ç„¶æ˜¯ä¸ªç»“æ„ä½“é‚£æˆ‘ä»¬çœ‹ä¸‹ç»“æ„ä½“æœ‰äº›ä»€ä¹ˆ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct objc_class &#123;</div><div class="line">    Class isa  OBJC_ISA_AVAILABILITY;</div><div class="line"></div><div class="line">#if !__OBJC2__</div><div class="line">    Class super_class                                        OBJC2_UNAVAILABLE;</div><div class="line">    const char *name                                         OBJC2_UNAVAILABLE;</div><div class="line">    long version                                             OBJC2_UNAVAILABLE;</div><div class="line">    long info                                                OBJC2_UNAVAILABLE;</div><div class="line">    long instance_size                                       OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_method_list **methodLists                    OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_cache *cache                                 OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_protocol_list *protocols                     OBJC2_UNAVAILABLE;</div><div class="line">#endif</div><div class="line"></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div></pre></td></tr></table></figure></p>
<p>æ„Ÿè§‰ä¸œè¥¿å¥½å¤šè€Œä¸”åŠ ä¸Šè¿™ä¹ˆå¤šçš„æ¦‚å¿µæœ‰äº›ä¹±å•Š</p>
<p>æˆ‘ä»¬å°±ç”¨ç®€å•çš„å›¾æ¥æè¿°æ€è·¯<br><img src="http://upload-images.jianshu.io/upload_images/1872052-76222435d30d1373.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>æ˜¯ä¸æ˜¯æ€è·¯æ¸…æ™°äº†è®¸å¤šï¼Ÿ<br>æˆ‘ä»¬ç€é‡æ¥çœ‹ä¸‹<code>methodLists</code><br>è€è§„çŸ©çœ‹çœ‹æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">struct objc_method_list &#123;</div><div class="line">    struct objc_method_list *obsolete                        OBJC2_UNAVAILABLE;</div><div class="line"></div><div class="line">    int method_count                                         OBJC2_UNAVAILABLE;</div><div class="line">#ifdef __LP64__</div><div class="line">    int space                                                OBJC2_UNAVAILABLE;</div><div class="line">#endif</div><div class="line">    /* variable length structure */</div><div class="line">    struct objc_method method_list[1]                        OBJC2_UNAVAILABLE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç»“æ„ä½“<code>methodLists</code>æ˜¯æŒ‡å‘<code>objc_method_list</code>æŒ‡é’ˆçš„æŒ‡é’ˆã€‚<br>å…¶ä¸­çš„<code>struct objc_method method_list[1]</code><br>çœ‹çœ‹å®˜æ–¹çš„æè¿°ä¸ºï¼šé•¿åº¦å¯å˜çš„ç»“æ„ä½“æ•°ç»„<br>ä¹Ÿå°±æ˜¯è¯´å¯ä»¥åŠ¨æ€ä¿®æ”¹*methodListsçš„å€¼æ¥æ·»åŠ æˆå‘˜æ–¹æ³•.</p>
<p>ç®€å•çš„ç†è§£å°±æ˜¯<code>methodLists</code>æ˜¯æ–¹æ³•çš„æ•°ç»„<br>é‡Œé¢å­˜ç€ç±»æˆ–è€…å®ä¾‹çš„æ–¹æ³•</p>
<p>æ¥çœ‹çœ‹objc_method<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">struct objc_method &#123;</div><div class="line">    SEL method_name                                          OBJC2_UNAVAILABLE;</div><div class="line">    char *method_types                                       OBJC2_UNAVAILABLE;</div><div class="line">    IMP method_imp                                           OBJC2_UNAVAILABLE;</div><div class="line">&#125;                                                            OBJC2_UNAVAILABLE;</div></pre></td></tr></table></figure></p>
<p>æ˜¯ä¸æ˜¯éå¸¸çœ¼ç†Ÿï¼ŸSEL <code>objc_msgSend</code>çš„ç¬¬äºŒä¸ªå‚æ•°<br>æ¥çœ‹çœ‹ä»–çš„çœŸé¢ç›®</p>
<h3 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_selector *SEL;</div></pre></td></tr></table></figure>
<p>ä¸€ä¸ªæŒ‡å‘<code>objc_selector</code>ç»“æ„ä½“çš„æŒ‡é’ˆ<br>ä½ å¯ä»¥ç†è§£ä¸ºï¼šSELæ˜¯ä¸€ä¸ªä»…ä»…åŒ…å«æ–¹æ³•åå­—çš„å­—ç¬¦ä¸²</p>
<h3 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">typedef id (*IMP)(id, SEL, ...);</div></pre></td></tr></table></figure>
<p>æ©ä»–æ˜¯ä¸ª<a href="http://yulingtianxia.com/blog/2014/04/17/han-shu-zhi-zhen-yu-zhi-zhen-han-shu/" target="_blank" rel="external">å‡½æ•°æŒ‡é’ˆ</a>ï¼Œå®ƒä¼šæŒ‡å‘ä¸€ä¸ªå‡½æ•°ã€‚<br>å½“å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šæ‰§è¡Œä¸€æ®µä»£ç ï¼Œå“ªé‡Œå»æ‰¾é‚£æ®µä»£ç å‘¢ï¼Ÿç”±IMPæ¥æŒ‡å®šã€‚</p>
<p>å¦‚æœä½ æ€è·¯æ¸…æ™°çš„è¯å¾ˆå¿«å¯ä»¥çœ‹å‡ºè¿™è´§çš„å‚æ•°å’Œ<code>objc_msgSend</code>çš„å‚æ•°ç›¸åŒ<br>ç¡®å®šä¸€ä¸ªIMPéœ€è¦idå’ŒSELã€‚æ¢å¥è¯è¯´ç»™æˆ‘ä¸€ä¸ªidï¼Œå’Œä¸€ä¸ªSELï¼ˆæ–¹æ³•åï¼‰å°±èƒ½ç¡®å®šä¸€ä¸ªæ–¹æ³•çš„IMPï¼ˆå®ç°ï¼‰ã€‚<br>åˆ°ç°åœ¨ä¸€å †çš„æ¦‚å¿µå¤´éƒ½å¿«ç‚¸äº†æˆ‘ä»¬æ¥å®Œå–„ä¸€ä¸‹æ€è·¯ç»“æ„å›¾<br><img src="http://upload-images.jianshu.io/upload_images/1872052-63b3a45f8f474100.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="éƒ¨åˆ†ç»“æ„å›¾"></p>
<p>é¡ºç€æ€è·¯æ˜¯ä¸æ˜¯è§‰å¾—æ€è·¯æ¸…æ™°äº†ä¸€äº›ï¼Œå¯¹ç»“æ„æœ‰äº†ä¸€äº›ç›´è§‚è®¤è¯†ã€‚<br>ä½†æ˜¯æœ‰å¥½å¤šçš„ä¸œè¥¿éƒ½æ²¡æœ‰ä»‹ç» ï¼Œæ…¢æ…¢æ¥ï¼Œä¸€å£åƒä¸æˆèƒ–å­ã€‚</p>
<p><code>method_types</code>è¡¨ç¤ºçš„æ˜¯æ–¹æ³•çš„<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">è¿”å›å€¼å’Œå‚æ•°ç¼–ç </a><br><img src="http://upload-images.jianshu.io/upload_images/1872052-fca126d96ab8331a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="è¿”å›å€¼å’Œå‚æ•°ç¼–ç "></p>
<p>åœ¨<code>runtime.h</code>ä¸­æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€äº›æœ‰å…³äºçš„å‡½æ•°<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">BOOL class_addMethod(Class cls, SEL name, IMP imp,</div><div class="line">                                 const char *types)</div><div class="line">IMP class_replaceMethod(Class cls, SEL name, IMP imp,</div><div class="line">                                    const char *types)</div></pre></td></tr></table></figure></p>
<p>æ·»åŠ æ–¹æ³•å’Œæ›¿æ¢æ–¹æ³•<br>ä¸‹é¢å†™ä¸€ä¸ªç®€å•ä¾‹å­æ¥ä½“ä¼šå®ƒå­˜åœ¨çš„æ„ä¹‰,æ‰‹å†™è¦æ·»åŠ ä¸€ä¸ªæ–¹æ³•éœ€è¦å‡ ä¸ªæ¡ä»¶ï¼šæ–¹æ³•å(SEL)ã€æ–¹æ³•çš„å®ç°åœ°å€(IMP)ã€æ–¹æ³•æ‰€å±çš„ç±»(Class)ã€‚<br>å¹¸è¿çš„æ˜¯runtime APIä¸ºæˆ‘ä»¬æä¾›äº†ä¾¿æ·çš„å®ç°IMPçš„Block<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">IMP imp_implementationWithBlock(id block)</div></pre></td></tr></table></figure></p>
<p>é‚£æˆ‘ä»¬å°±ç°åœ¨æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç±»å¹¶æœªå…¶æ·»åŠ ä¸€ä¸ªæ–¹æ³•testï¼Œå¹¶å°é‡å†™descriptionæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        //åˆ›å»ºç»§æ‰¿è‡ªNSObjectç±»çš„Peopleç±»</div><div class="line">        Class People = objc_allocateClassPair([NSObject class], &quot;People&quot;, 0);</div><div class="line">        //å°†Peopleç±»æ³¨å†Œåˆ°runtimeä¸­</div><div class="line">        objc_registerClassPair(People);</div><div class="line">        //æ³¨å†Œtest: æ–¹æ³•é€‰æ‹©å™¨</div><div class="line">        SEL sel = sel_registerName(&quot;test:&quot;);</div><div class="line">        //å‡½æ•°å®ç°</div><div class="line">        IMP imp = imp_implementationWithBlock(^(id this,id args)&#123;</div><div class="line">            NSLog(@&quot;æ–¹æ³•çš„è°ƒç”¨è€…ä¸º %@&quot;,this);</div><div class="line">            NSLog(@&quot;å‚æ•°ä¸º %@&quot;,args);</div><div class="line">            return @&quot;è¿”å›å€¼æµ‹è¯•&quot;;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        //å‘Peopleç±»ä¸­æ·»åŠ  test:æ–¹æ³•;å‡½æ•°ç­¾åä¸º@@:@,</div><div class="line">        //    ç¬¬ä¸€ä¸ª@è¡¨ç¤ºè¿”å›å€¼ç±»å‹ä¸ºid,</div><div class="line">        //    ç¬¬äºŒä¸ª@è¡¨ç¤ºçš„æ˜¯å‡½æ•°çš„è°ƒç”¨è€…ç±»å‹,</div><div class="line">        //    ç¬¬ä¸‰ä¸ª:è¡¨ç¤º SEL</div><div class="line">        //    ç¬¬å››ä¸ª@è¡¨ç¤ºéœ€è¦ä¸€ä¸ªidç±»å‹çš„å‚æ•°</div><div class="line">        class_addMethod(People, sel, imp, &quot;@@:@&quot;);</div><div class="line">        //æ›¿æ¢Peopleä»NSObjectç±»ä¸­ç»§æ‰¿è€Œæ¥çš„descriptionæ–¹æ³•</div><div class="line">        class_replaceMethod(People,@selector(description), imp_implementationWithBlock(^NSString*(id this,...)&#123;</div><div class="line">            return @&quot;æˆ‘æ˜¯Personç±»çš„å¯¹è±¡&quot;;&#125;),</div><div class="line">                            &quot;@@:&quot;);</div><div class="line"></div><div class="line">        //å®Œæˆ [[People alloc]init];</div><div class="line">        id p1 = objc_msgSend(objc_msgSend(People, @selector(alloc)),@selector(init));</div><div class="line">        //è°ƒç”¨p1çš„selé€‰æ‹©å™¨çš„æ–¹æ³•,å¹¶ä¼ é€’@&quot;???&quot;ä½œä¸ºå‚æ•°</div><div class="line">        id result = objc_msgSend(p1, sel,@&quot;???&quot;);</div><div class="line">        //è¾“å‡ºselæ–¹æ³•çš„è¿”å›å€¼</div><div class="line">        NSLog(@&quot;sel æ–¹æ³•çš„è¿”å›å€¼ä¸º ï¼š %@&quot;,result);</div><div class="line"></div><div class="line">        //è·å–Peopleç±»ä¸­å®ç°çš„æ–¹æ³•åˆ—è¡¨</div><div class="line">        NSLog(@&quot;è¾“å‡ºPeopleç±»ä¸­å®ç°çš„æ–¹æ³•åˆ—è¡¨&quot;);</div><div class="line">        unsigned int methodCount;</div><div class="line">        Method * methods = class_copyMethodList(People, &amp;methodCount);</div><div class="line">        for (int i = 0; i&lt;methodCount; i++) &#123;</div><div class="line">            NSLog(@&quot;æ–¹æ³•åç§°:%s&quot;,sel_getName(method_getName(methods[i])));</div><div class="line">            NSLog(@&quot;æ–¹æ³•Types:%s&quot;,method_getDescription(methods[i])-&gt;types);</div><div class="line">        &#125;</div><div class="line">        free(methods);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‚è€ƒï¼š<br><a href="[http://www.jianshu.com/p/c0157110caa5">http://www.jianshu.com/p/c0157110caa5</a><br><a href="http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/" target="_blank" rel="external">http://yulingtianxia.com/blog/2014/11/05/objective-c-runtime/</a></p>

 
                <!-- Meta -->
                <div class="post-meta">
                    <hr>
                    <br>
                    <div class="post-tags">
                        
                    </div>
                    <div class="post-date">
                        2017 å¹´ 09 æœˆ 08 æ—¥
                    </div>
                </div>
            </div>

            <!-- Comments -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- Disqus Comments -->


            </div>
        </div>
    </div>
</article>
</section>

    <!-- Scripts -->
    <!-- jQuery -->
<script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script type="text/javascript">
	console.log('Hexo-theme-hollow designed by zchen9 ğŸ™‹ Â© 2015-' + (new Date()).getFullYear());
</script>

    <!-- Google Analytics -->
    

</body>

</html>